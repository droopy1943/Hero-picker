<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Marvel Rivals Queue Admin</title>
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      background: #0a0a0a;
      color: #f2f2f2;
      padding: 20px;
    }
    h1 { color: #e62429; }
    label { display:block; margin-top: 10px; }
    input {
      width: 350px;
      padding: 6px;
      border-radius: 4px;
      border: none;
      outline: none;
    }
    button {
      padding: 8px 14px;
      margin-top: 10px;
      border: none;
      background: #e62429;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    ul { list-style:none; padding-left:0; }
    li { background:#111; padding:8px 10px; border-radius:6px; margin:6px 0; }
    a { color:#61dafb; text-decoration:none; }
  </style>
</head>
<body>
  <h1>Marvel Rivals Queue Admin</h1>

  <div>
    <label>Channel ID (your Twitch or Streamlabs username)
      <input id="channelId" placeholder="droopy2" />
    </label>
    <label>Streamlabs Socket Token (keep private)
      <input id="slToken" placeholder="Paste your token here" />
    </label>
    <div class="row">
      <button id="save">Save</button>
      <button id="connect">Connect Streamlabs</button>
      <a id="openOverlay" target="_blank">Open Overlay</a>
    </div>
  </div>

  <hr />

  <div class="row">
    <input id="manualHero" placeholder="Hero name (manual add)" />
    <input id="manualDonor" placeholder="Donor name (optional)" />
    <button id="addManual">Add to Queue</button>
  </div>

  <h2>Queue</h2>
  <button id="nextHero">Next Hero → Send to Overlay</button>
  <ul id="queueList"></ul>

  <!-- Streamlabs socket.io client -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <!-- Firebase integration -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    // ✅ Your Firebase config
    const firebaseConfig = {
  apiKey: "AIzaSyASjfLh3w3UQHRy1wvmWwD5ZfaXWjVYTnE",
  authDomain: "marvel-rivals-overlay-7f867.firebaseapp.com",
  databaseURL: "https://marvel-rivals-overlay-7f867-default-rtdb.firebaseio.com",
  projectId: "marvel-rivals-overlay-7f867",
  storageBucket: "marvel-rivals-overlay-7f867.firebasestorage.app",
  messagingSenderId: "1078364810175",
  appId: "1:1078364810175:web:fac410007b70b65e348f0a"
};

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const auth = getAuth(app);
    await signInAnonymously(auth);

    // DOM references
    const el = id => document.getElementById(id);
    const channelIdInput = el("channelId");
    const slTokenInput   = el("slToken");
    const saveBtn        = el("save");
    const connectBtn     = el("connect");
    const openOverlayA   = el("openOverlay");
    const addManualBtn   = el("addManual");
    const nextBtn        = el("nextHero");
    const queueList      = el("queueList");
    const manualHero     = el("manualHero");
    const manualDonor    = el("manualDonor");

    // Load saved settings
    const cfg = JSON.parse(localStorage.getItem("mr_cfg") || "{}");
    if (cfg.channelId) channelIdInput.value = cfg.channelId;
    if (cfg.slToken)   slTokenInput.value   = cfg.slToken;

    function refreshOverlayLink() {
      const cid = channelIdInput.value.trim() || "demo";
      openOverlayA.href = `overlay.html?channel=${encodeURIComponent(cid)}`;
      openOverlayA.textContent = "Open Overlay";
    }
    refreshOverlayLink();

    saveBtn.onclick = () => {
      const newCfg = {
        channelId: channelIdInput.value.trim(),
        slToken: slTokenInput.value.trim()
      };
      localStorage.setItem("mr_cfg", JSON.stringify(newCfg));
      refreshOverlayLink();
      alert("Saved!");
    };

    // Live queue updates
    function subscribeQueue() {
      const cid = channelIdInput.value.trim() || "demo";
      onValue(ref(db, `/channels/${cid}/queue`), (snap) => {
        const q = snap.val() || [];
        queueList.innerHTML = "";
        q.forEach((item, idx) => {
          const li = document.createElement("li");
          li.textContent = `#${idx+1} — ${item.hero}` +
            (item.donor ? ` by ${item.donor}` : "") +
            (item.amount ? ` ($${item.amount})` : "");
          queueList.appendChild(li);
        });
      });
    }
    subscribeQueue();

    // Manual Add
    addManualBtn.onclick = async () => {
      const cid = channelIdInput.value.trim() || "demo";
      const hero = manualHero.value.trim();
      const donor = manualDonor.value.trim();
      if (!hero) return alert("Enter a hero name.");
      const qRef = ref(db, `/channels/${cid}/queue`);
      const snap = await get(qRef);
      const q = snap.val() || [];
      q.push({ hero, donor: donor || null, ts: Date.now() });
      await set(qRef, q);
      manualHero.value = "";
      manualDonor.value = "";
    };

    // Next Hero (move to overlay)
    nextBtn.onclick = async () => {
      const cid = channelIdInput.value.trim() || "demo";
      const qRef = ref(db, `/channels/${cid}/queue`);
      const curRef = ref(db, `/channels/${cid}/current`);
      const snap = await get(qRef);
      const q = snap.val() || [];
      if (!q.length) return alert("Queue empty.");
      const next = q.shift();
      await set(curRef, next);
      await set(qRef, q);
    };

    // Streamlabs socket connection
    let socket;
    connectBtn.onclick = () => {
      const token = slTokenInput.value.trim();
      const cid   = channelIdInput.value.trim() || "demo";
      if (!token) return alert("Paste your Streamlabs Socket Token first.");

      if (socket && socket.connected) socket.disconnect();

      socket = io("https://sockets.streamlabs.com", {
        transports: ["websocket"],
        query: { token }
      });

      socket.on("connect", () => console.log("✅ Streamlabs socket connected"));
      socket.on("disconnect", () => console.log("❌ Streamlabs socket disconnected"));

      socket.on("event", async (eventData) => {
        if (eventData.type !== "donation") return;

        const arr = Array.isArray(eventData.message)
          ? eventData.message
          : [eventData.message];

        for (const m of arr) {
          const name   = m.name || "Anonymous";
          const amount = m.amount || 0;
          const note   = (m.message || "").toString();
          const match  = note.match(/I\s*want\s*to\s*request\s*\[([^\]]+)\]/i);
          if (!match) continue;

          const hero = match[1].trim();
          const qRef = ref(db, `/channels/${cid}/queue`);
          const snap = await get(qRef);
          const q = snap.val() || [];
          q.push({ hero, donor: name, amount: Number(amount), ts: Date.now() });
          await set(qRef, q);
          console.log(`🦸 Added: ${hero} by ${name}`);
        }
      });

      alert("Connected to Streamlabs! Leave this page open while streaming.");
    };
  </script>
</body>
</html>
