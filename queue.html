<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Droopy Hero Overlay — Queue Admin</title>
<style>
  body {
    background: #111827;
    color: #e5e7eb;
    font-family: "Segoe UI", sans-serif;
    margin: 0;
    padding: 20px;
  }

  h1 {
    font-size: 1.8rem;
    margin-bottom: 20px;
  }

  .card {
    background: #1f2937;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  .card h2 {
    font-size: 1.2rem;
    margin-top: 0;
  }

  .input-row {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  input, textarea {
    background: #374151;
    color: #f9fafb;
    border: none;
    border-radius: 8px;
    padding: 10px;
    flex: 1;
    font-size: 0.95rem;
  }

  input::placeholder {
    color: #9ca3af;
  }

  button {
    border: none;
    border-radius: 8px;
    padding: 10px 18px;
    font-weight: bold;
    cursor: pointer;
    color: white;
    transition: background 0.2s;
  }

  .save-btn { background: #ef4444; }
  .save-btn:hover { background: #dc2626; }

  .test-btn { background: #374151; }
  .test-btn:hover { background: #4b5563; }

  .connect-btn { background: #374151; }
  .connect-btn:hover { background: #4b5563; }

  .next-btn { background: #22c55e; }
  .next-btn:hover { background: #16a34a; }

  .clear-btn { background: #f59e0b; }
  .clear-btn:hover { background: #d97706; }

  .add-btn { background: #ef4444; }
  .add-btn:hover { background: #dc2626; }

  .collapse-btn {
    background: #374151;
    font-weight: bold;
    border-radius: 8px;
    padding: 6px 10px;
    float: right;
  }

  .queue-item {
    background: #111827;
    border-radius: 8px;
    padding: 10px 14px;
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .queue-item span {
    font-size: 0.9rem;
  }

  .status-box {
    background: #1f2937;
    border-radius: 12px;
    padding: 15px;
    font-family: monospace;
    white-space: pre-wrap;
    font-size: 0.85rem;
    color: #d1d5db;
  }

  .status-badge {
    background: #374151;
    color: #9ca3af;
    border-radius: 12px;
    padding: 4px 10px;
    float: right;
    font-size: 0.75rem;
  }

  .hidden { display: none; }
</style>
</head>

<body>
  <h1>Droopy Hero Overlay — Queue Admin</h1>

  <div class="card" id="setupCard">
    <h2>Setup <button id="collapseBtn" class="collapse-btn">Collapse</button></h2>
    <p>Enter your <b>Channel ID</b> (usually your Streamlabs/Twitch username). Optional: paste your <b>Streamlabs Socket Token</b> to auto-queue from donations.</p>

    <div class="input-row">
      <input id="channelId" placeholder="Channel ID" value="Droopy">
      <input id="socketToken" placeholder="Streamlabs Socket Token (optional)">
    </div>
    <p style="font-size: 0.85rem; color: #9ca3af;">All your data lives at <code>/channels/&lt;yourID&gt;/...</code></p>

    <div class="input-row">
      <button class="save-btn" id="saveSetup">Save Setup</button>
      <button class="test-btn" id="testFirebase">Test Firebase</button>
      <button class="connect-btn" id="connectStreamlabs">Connect Streamlabs</button>
    </div>

    <p style="margin-top:10px;">Use this URL in an OBS Browser Source:</p>
    <div class="input-row">
      <input id="obsUrl" readonly>
      <button id="copyObs" class="test-btn">Copy</button>
      <button id="openOverlay" class="test-btn">Open Overlay</button>
    </div>
  </div>

  <div class="card">
    <h2>Queue</h2>
    <div class="input-row">
      <input id="heroInput" placeholder="Type or pick a hero...">
      <input id="donorInput" placeholder="e.g., John">
      <button id="addHero" class="add-btn">Add to Queue</button>
    </div>

    <div id="queueList"></div>

    <div class="input-row" style="margin-top: 12px;">
      <button id="nextHero" class="next-btn">Next Hero → Overlay</button>
      <button id="clearQueue" class="clear-btn">Clear Queue</button>
    </div>
  </div>

  <div class="card">
    <h2>Status <span class="status-badge" id="statusLabel">Listening @ /channels/Droopy/queue</span></h2>
    <div class="status-box" id="statusBox"></div>
  </div>

  <!-- Hero list auto-load -->
  <script>
  async function loadHeroList() {
    const heroInput = document.getElementById('heroInput');
    if (!heroInput) return;

    try {
      const response = await fetch('heroList.json');
      const data = await response.json();
      const heroes = data.heroes || [];

      const datalist = document.createElement('datalist');
      datalist.id = 'hero-list';
      heroes.forEach(hero => {
        const option = document.createElement('option');
        option.value = hero.name;
        datalist.appendChild(option);
      });
      document.body.appendChild(datalist);

      heroInput.setAttribute('list', 'hero-list');
      console.log(`Loaded ${heroes.length} heroes from heroList.json`);
    } catch (err) {
      console.error('Error loading heroList.json:', err);
    }
  }
  window.addEventListener('DOMContentLoaded', loadHeroList);
  </script>

  <!-- Firebase logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, set, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASjfLh3w3UQHRy1wvmWwD5ZfaXWjVYTnE",
      authDomain: "marvel-rivals-overlay-7f867.firebaseapp.com",
      databaseURL: "https://marvel-rivals-overlay-7f867-default-rtdb.firebaseio.com",
      projectId: "marvel-rivals-overlay-7f867",
      storageBucket: "marvel-rivals-overlay-7f867.appspot.com",
      messagingSenderId: "1078364810175",
      appId: "1:1078364810175:web:fac410007b70b65e348f0a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const statusBox = document.getElementById("statusBox");
    const queueList = document.getElementById("queueList");

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      statusBox.textContent += `[${time}] ${msg}\n`;
      statusBox.scrollTop = statusBox.scrollHeight;
    }

    document.getElementById("saveSetup").onclick = () => {
      const channel = document.getElementById("channelId").value.trim() || "demo";
      localStorage.setItem("channelId", channel);
      document.getElementById("statusLabel").textContent = `Listening @ /channels/${channel}/queue`;
      const obsUrl = `https://droopy1943.github.io/Hero-picker/overlay.html?channel=${channel}`;
      document.getElementById("obsUrl").value = obsUrl;
      log(`Saved settings for channel: ${channel}`);
    };

    document.getElementById("testFirebase").onclick = async () => {
      const channel = localStorage.getItem("channelId") || "demo";
      await set(ref(db, `/channels/${channel}/test`), { ok: true, ts: Date.now() });
      log("Test: wrote Blade to your queue.");
    };

    document.getElementById("addHero").onclick = async () => {
      const channel = localStorage.getItem("channelId") || "demo";
      const hero = document.getElementById("heroInput").value.trim();
      const donor = document.getElementById("donorInput").value.trim() || "Anonymous";
      if (!hero) return;

      const qRef = ref(db, `/channels/${channel}/queue`);
      await push(qRef, { hero, donor, ts: Date.now() });
      log(`Added to queue: ${hero} by ${donor}`);
      document.getElementById("heroInput").value = "";
      document.getElementById("donorInput").value = "";
    };

    document.getElementById("clearQueue").onclick = async () => {
      const channel = localStorage.getItem("channelId") || "demo";
      await remove(ref(db, `/channels/${channel}/queue`));
      log("Queue cleared.");
      queueList.innerHTML = "";
    };

    document.getElementById("nextHero").onclick = async () => {
      const channel = localStorage.getItem("channelId") || "demo";
      const qRef = ref(db, `/channels/${channel}/queue`);
      const curRef = ref(db, `/channels/${channel}/current`);

      onValue(qRef, async (snap) => {
        const queue = snap.val();
        if (!queue) return;
        const keys = Object.keys(queue);
        const first = queue[keys[0]];
        await set(curRef, { hero: first.hero, donor: first.donor, ts: Date.now() });
        log(`Sent to overlay: ${first.hero}`);
        await remove(ref(db, `/channels/${channel}/queue/${keys[0]}`));
      }, { onlyOnce: true });
    };

    document.getElementById("collapseBtn").onclick = () => {
      document.getElementById("setupCard").classList.toggle("hidden");
    };

    onValue(ref(db, `/channels/demo/queue`), (snap) => {
      const queue = snap.val();
      queueList.innerHTML = "";
      if (queue) {
        const keys = Object.keys(queue);
        keys.forEach((k, i) => {
          const q = queue[k];
          const div = document.createElement("div");
          div.className = "queue-item";
          div.innerHTML = `<span>#${i+1} — <b>${q.hero}</b> by ${q.donor}</span><span>${new Date(q.ts).toLocaleTimeString()}</span>`;
          queueList.appendChild(div);
        });
      }
    });
  </script>
</body>
</html>
