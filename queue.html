<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Droopy Hero Overlay — Queue Admin</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background-color: #111;
    color: #e6e6e6;
    margin: 0;
    padding: 20px;
  }

  h1 {
    text-align: center;
    margin-bottom: 25px;
  }

  .card {
    background-color: #1a1a1f;
    border-radius: 12px;
    box-shadow: 0 0 8px rgba(0,0,0,0.6);
    padding: 20px;
    margin-bottom: 20px;
  }

  .section-title {
    font-weight: bold;
    font-size: 1.1em;
    background-color: #252530;
    border-radius: 8px;
    padding: 6px 12px;
    display: inline-block;
    margin-bottom: 15px;
  }

  input, button {
    border-radius: 8px;
    border: none;
    outline: none;
    padding: 8px 12px;
    font-size: 14px;
  }

  input {
    background-color: #2a2a33;
    color: #eee;
    margin: 4px;
    width: 240px;
  }

  button {
    cursor: pointer;
    margin: 4px;
    font-weight: bold;
  }

  .saveSetup { background-color: #d83b3b; color: white; }
  .testFirebase, .connectStreamlabs, .openOverlay, .copyLink { background-color: #2d2d3a; color: #fff; }
  .nextHero { background-color: #32a852; color: white; }
  .clearQueue { background-color: #e8a61e; color: black; }
  .addQueue { background-color: #d83b3b; color: white; }

  .saveSetup:hover, .addQueue:hover, .nextHero:hover, .clearQueue:hover {
    filter: brightness(1.1);
  }

  .queue-item {
    background-color: #202025;
    border-radius: 6px;
    padding: 8px 12px;
    margin: 5px 0;
    display: flex;
    justify-content: space-between;
  }

  .status {
    font-family: monospace;
    background-color: #18181c;
    padding: 10px;
    border-radius: 8px;
    height: 150px;
    overflow-y: auto;
  }

  .collapse-btn {
    float: right;
    background-color: #2d2d3a;
    color: white;
    border-radius: 6px;
    font-size: 12px;
  }

  .hidden { display: none; }

</style>
</head>

<body>
  <h1>Droopy Hero Overlay — Queue Admin</h1>

  <!-- Setup Section -->
  <div class="card" id="setup-card">
    <div class="section-title">Setup
      <button class="collapse-btn" id="collapse-btn">Collapse</button>
    </div>
    <p>Enter your <b>Channel ID</b> (usually your Streamlabs/Twitch username). Optional: paste your <b>Streamlabs Socket Token</b> to auto-queue from donations.</p>

    <input type="text" id="channelId" placeholder="Droopy">
    <input type="text" id="socketToken" placeholder="Paste token for auto-queue on donations">

    <div>
      <button class="saveSetup">Save Setup</button>
      <button class="testFirebase">Test Firebase</button>
      <button class="connectStreamlabs">Connect Streamlabs</button>
    </div>

    <p>Use this URL in an OBS Browser Source:</p>
    <div style="display:flex; align-items:center; gap:6px;">
      <input type="text" id="overlayUrl" readonly>
      <button class="copyLink">Copy</button>
      <button class="openOverlay">Open Overlay</button>
    </div>
  </div>

  <!-- Queue Section -->
  <div class="card">
    <div class="section-title">Queue</div>
    <div>
      <input type="text" id="heroInput" placeholder="Type or pick a hero...">
      <input type="text" id="donorInput" placeholder="e.g., John">
      <button class="addQueue">Add to Queue</button>
    </div>

    <div style="margin-top:10px;">
      <button class="nextHero">Next Hero → Overlay</button>
      <button class="clearQueue">Clear Queue</button>
    </div>

    <div class="queue-list" style="margin-top:15px;"></div>
  </div>

  <!-- Status Section -->
  <div class="card">
    <div class="section-title">Status</div>
    <div class="status"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, set, get, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASjfLh3w3UQHRy1wvmWwD5ZfaXWjVYTnE",
      authDomain: "marvel-rivals-overlay-7f867.firebaseapp.com",
      databaseURL: "https://marvel-rivals-overlay-7f867-default-rtdb.firebaseio.com",
      projectId: "marvel-rivals-overlay-7f867",
      storageBucket: "marvel-rivals-overlay-7f867.appspot.com",
      messagingSenderId: "1078364810175",
      appId: "1:1078364810175:web:fac410007b70b65e348f0a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM Elements
    const heroInput = document.getElementById("heroInput");
    const donorInput = document.getElementById("donorInput");
    const statusBox = document.querySelector(".status");
    const queueContainer = document.querySelector(".queue-list");
    const channelInput = document.getElementById("channelId");
    const overlayUrl = document.getElementById("overlayUrl");

    let channelId = localStorage.getItem("channelId") || "demo";

    function logStatus(msg) {
      const time = new Date().toLocaleTimeString();
      statusBox.innerHTML = `[${time}] ${msg}<br>` + statusBox.innerHTML;
    }

    function refs() {
      return {
        queueRef: ref(db, `/channels/${channelId}/queue`),
        currentRef: ref(db, `/channels/${channelId}/current`)
      };
    }

    // Render queue in UI
    function renderQueue(queue) {
      queueContainer.innerHTML = "";
      queue.forEach((entry, i) => {
        const div = document.createElement("div");
        div.className = "queue-item";
        div.innerHTML = `<b>#${i + 1} — ${entry.hero}</b> ${entry.donor ? "by " + entry.donor : ""}`;
        queueContainer.appendChild(div);
      });
    }

    // Refresh queue from Firebase
    async function refreshQueue() {
      const { queueRef } = refs();
      const snap = await get(queueRef);
      if (!snap.exists()) {
        queueContainer.innerHTML = "<i>Queue empty</i>";
        return;
      }
      renderQueue(Object.values(snap.val()));
    }

    // Add hero to queue
    async function addToQueue() {
      const hero = heroInput.value.trim();
      if (!hero) return alert("Enter a hero name!");
      const donor = donorInput.value.trim();
      const { queueRef } = refs();
      const snap = await get(queueRef);
      const q = snap.exists() ? Object.values(snap.val()) : [];
      q.push({ hero, donor, ts: Date.now() });
      await set(queueRef, q);
      logStatus(`Added to queue: ${hero}${donor ? " by " + donor : ""}`);
      heroInput.value = "";
      donorInput.value = "";
      refreshQueue();
    }

    // Next hero → overlay
    async function nextHero() {
      const { queueRef, currentRef } = refs();
      const snap = await get(queueRef);
      if (!snap.exists()) return logStatus("Queue is empty!");
      const q = Object.values(snap.val());
      const next = q.shift();
      if (!next) return;
      await set(currentRef, next);
      await set(queueRef, q);
      logStatus(`Sent ${next.hero} to overlay.`);
      refreshQueue();
    }

    // Clear queue
    async function clearQueue() {
      const { queueRef } = refs();
      await remove(queueRef);
      logStatus("Queue cleared.");
      refreshQueue();
    }

    // Save setup
    document.querySelector(".saveSetup").onclick = () => {
      const id = channelInput.value.trim();
      if (!id) return alert("Please enter Channel ID");
      channelId = id;
      localStorage.setItem("channelId", id);
      overlayUrl.value = `https://droopy1943.github.io/Hero-picker/overlay.html?channel=${id}`;
      logStatus(`Saved settings for channel: ${id}`);
      refreshQueue();
    };

    document.querySelector(".testFirebase").onclick = refreshQueue;
    document.querySelector(".addQueue").onclick = addToQueue;
    document.querySelector(".nextHero").onclick = nextHero;
    document.querySelector(".clearQueue").onclick = clearQueue;

    document.getElementById("collapse-btn").onclick = () => {
      const card = document.getElementById("setup-card");
      card.classList.toggle("hidden");
    };

    document.querySelector(".copyLink").onclick = () => {
      navigator.clipboard.writeText(overlayUrl.value);
      logStatus("Copied overlay link.");
    };

    document.querySelector(".openOverlay").onclick = () => {
      window.open(overlayUrl.value, "_blank");
    };

    // Auto-load saved channel
    channelInput.value = channelId;
    overlayUrl.value = `https://droopy1943.github.io/Hero-picker/overlay.html?channel=${channelId}`;
    refreshQueue();

    // Watch queue live
    onValue(ref(db, `/channels/${channelId}/queue`), (snap) => {
      if (!snap.exists()) return (queueContainer.innerHTML = "<i>Queue empty</i>");
      renderQueue(Object.values(snap.val()));
    });
  </script>
</body>
</html>
