<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Droopy Hero Overlay — Queue Admin</title>
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background-color: #0b0b0b;
    color: #e4e4e4;
    margin: 0;
    padding: 20px;
  }
  h1 {
    text-align: center;
    color: #fff;
    margin-bottom: 20px;
  }
  .card {
    background: #141414;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 0 15px rgba(0,0,0,0.7);
  }
  h2 { margin-top: 0; }
  input, button {
    font-family: inherit;
    border-radius: 6px;
    padding: 8px;
    margin: 5px;
    font-size: 14px;
  }
  input {
    background: #222;
    color: #fff;
    border: 1px solid #333;
    width: 200px;
  }
  button {
    cursor: pointer;
    border: none;
    font-weight: bold;
  }
  .primary { background: #e63946; color: white; }
  .secondary { background: #2a2a2a; color: white; }
  .green { background: #2a9d8f; color: white; }
  .yellow { background: #f4a261; color: #111; }
  .hidden { display: none; }
  .queue-item {
    background: #1d1d1d;
    border-radius: 8px;
    padding: 8px 10px;
    margin: 4px 0;
  }
  .status {
    background: #1e1e1e;
    padding: 10px;
    border-radius: 8px;
    height: 120px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 13px;
  }
  #setupBody { transition: max-height 0.3s ease; }
  #setupBody.hidden { max-height: 0; overflow: hidden; padding: 0; }
</style>
</head>

<body>
  <h1>Droopy Hero Overlay — Queue Admin</h1>

  <div class="card">
    <h2>Setup</h2>
    <button id="collapseBtn" class="secondary" style="float:right;">Collapse</button>
    <div id="setupBody">
      <p>Enter your <b>Channel ID</b> (your Twitch/Streamlabs username):</p>
      <input type="text" id="channelId" placeholder="Channel ID">
      <input type="text" id="socketToken" placeholder="Streamlabs Socket Token (optional)">
      <br><br>
      <button id="saveSetup" class="primary">Save Setup</button>
      <button id="testFirebase" class="secondary">Test Firebase</button>
      <button id="connectStreamlabs" class="secondary">Connect Streamlabs</button>
      <p>Use this URL for OBS Overlay:</p>
      <code id="overlayUrl" style="background:#1e1e1e;padding:6px 10px;border-radius:6px;display:block;"></code>
    </div>
  </div>

  <div class="card">
    <h2>Queue</h2>
    <input type="text" id="heroInput" placeholder="Hero name">
    <input type="text" id="donorInput" placeholder="Donor name (optional)">
    <br>
    <button id="addHero" class="primary">Add to Queue</button>
    <button id="nextHero" class="green">Next Hero → Overlay</button>
    <button id="clearQueue" class="yellow">Clear Queue</button>
    <div id="queueList" style="margin-top:15px;"></div>
  </div>

  <div class="card">
    <h2>Status</h2>
    <div id="status" class="status">Idle...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASjfLh3w3UQHRy1wvmWwD5ZfaXWjVYTnE",
      authDomain: "marvel-rivals-overlay-7f867.firebaseapp.com",
      databaseURL: "https://marvel-rivals-overlay-7f867-default-rtdb.firebaseio.com",
      projectId: "marvel-rivals-overlay-7f867",
      storageBucket: "marvel-rivals-overlay-7f867.appspot.com",
      messagingSenderId: "1078364810175",
      appId: "1:1078364810175:web:fac410007b70b65e348f0a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const status = document.getElementById("status");
    const heroInput = document.getElementById("heroInput");
    const donorInput = document.getElementById("donorInput");
    const queueList = document.getElementById("queueList");
    const channelInput = document.getElementById("channelId");
    const overlayUrl = document.getElementById("overlayUrl");
    const collapseBtn = document.getElementById("collapseBtn");
    const setupBody = document.getElementById("setupBody");

    let channelId = localStorage.getItem("channelId") || "demo";

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      status.innerHTML = `[${time}] ${msg}<br>` + status.innerHTML;
    }

    function refs() {
      return {
        queueRef: ref(db, `/channels/${channelId}/queue`),
        currentRef: ref(db, `/channels/${channelId}/current`)
      };
    }

    async function refreshQueue() {
      const { queueRef } = refs();
      const snap = await get(queueRef);
      if (!snap.exists()) {
        queueList.innerHTML = "<i>Queue empty</i>";
        return;
      }
      const queue = Object.values(snap.val());
      queueList.innerHTML = queue.map((q, i) =>
        `<div class="queue-item"><b>#${i + 1}:</b> ${q.hero}${q.donor ? " — " + q.donor : ""}</div>`
      ).join("");
    }

    async function addHero() {
      const hero = heroInput.value.trim();
      if (!hero) return alert("Enter hero name!");
      const donor = donorInput.value.trim();
      const { queueRef } = refs();
      const snap = await get(queueRef);
      const q = snap.exists() ? Object.values(snap.val()) : [];
      q.push({ hero, donor, ts: Date.now() });
      await set(queueRef, q);
      log(`Added to queue: ${hero}${donor ? " by " + donor : ""}`);
      heroInput.value = donorInput.value = "";
      refreshQueue();
    }

    async function nextHero() {
      const { queueRef, currentRef } = refs();
      const snap = await get(queueRef);
      if (!snap.exists()) return log("Queue empty.");
      const q = Object.values(snap.val());
      const next = q.shift();
      if (!next) return;
      await set(currentRef, next);
      await set(queueRef, q);
      log(`Sent ${next.hero} to overlay.`);
      refreshQueue();
    }

    async function clearQueue() {
      const { queueRef } = refs();
      await remove(queueRef);
      log("Queue cleared.");
      refreshQueue();
    }

    document.getElementById("saveSetup").onclick = () => {
      const id = channelInput.value.trim();
      if (!id) return alert("Enter a Channel ID first!");
      channelId = id;
      localStorage.setItem("channelId", id);
      overlayUrl.textContent = `https://droopy1943.github.io/Hero-picker/overlay.html?channel=${id}`;
      log(`Saved setup for channel: ${id}`);
      refreshQueue();
    };

    document.getElementById("testFirebase").onclick = () => {
      refreshQueue();
      log("Firebase connection tested.");
    };
    document.getElementById("addHero").onclick = addHero;
    document.getElementById("nextHero").onclick = nextHero;
    document.getElementById("clearQueue").onclick = clearQueue;

    collapseBtn.onclick = () => {
      setupBody.classList.toggle("hidden");
      collapseBtn.textContent = setupBody.classList.contains("hidden") ? "Expand" : "Collapse";
    };

    channelInput.value = channelId;
    overlayUrl.textContent = `https://droopy1943.github.io/Hero-picker/overlay.html?channel=${channelId}`;
    refreshQueue();

    onValue(ref(db, `/channels/${channelId}/queue`), (snap) => {
      if (!snap.exists()) return queueList.innerHTML = "<i>Queue empty</i>";
      const q = Object.values(snap.val());
      queueList.innerHTML = q.map((x, i) =>
        `<div class="queue-item"><b>#${i + 1}:</b> ${x.hero}${x.donor ? " — " + x.donor : ""}</div>`
      ).join("");
    });
  </script>
</body>
</html>
