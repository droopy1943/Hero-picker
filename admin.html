<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rivals — License Admin</title>
<style>
  body {
    background: #0b0b0f; color: #e6f3ff; font-family: system-ui, sans-serif; margin: 0;
    display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 30px;
  }
  .container { width: 860px; background: #11121a; border-radius: 16px; padding: 24px; box-shadow: 0 8px 40px rgba(0,0,0,.4); }
  h1 { font-size: 26px; margin-top: 0; display:flex; justify-content:space-between; align-items:center; }
  .card { background:#151721; border:1px solid #22263a; border-radius:14px; padding:16px 20px; margin-bottom:20px; }
  input[type=text] { background:#0e1018; color:#fff; border:1px solid #2a2e3e; border-radius:8px; padding:10px; width:100%; }
  label { font-size:14px; color:#9aa0aa; }
  button { cursor:pointer; border:none; border-radius:8px; padding:10px 16px; font-weight:600; transition:all .15s ease; }
  .btn-primary { background:#e62429; color:#fff; }
  .btn-primary:hover { opacity:.9; }
  .btn-secondary { background:#2a2e3e; color:#fff; }
  .btn-warning { background:#f39c12; color:#111; }
  .btn-copy { background:#3b3f52; color:#fff; }
  .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
  .license-item { display:flex; justify-content:space-between; align-items:center; background:#0f1118; border:1px solid #2a2e3e; border-radius:10px; padding:10px 12px; margin-top:8px; animation:fadeIn .3s ease; }
  @keyframes fadeIn { from {opacity:0; transform:translateY(5px);} to {opacity:1; transform:translateY(0);} }
  .pill { padding:4px 10px; border-radius:999px; font-size:12px; }
  .pill.active { background:#2ecc71; color:#000; }
  .pill.inactive { background:#e62429; color:#fff; }
  .muted { color:#9aa0aa; font-size:13px; }
</style>
</head>
<body>
  <div class="container">
    <h1>
      Rivals — License Admin
      <span class="pill active">Local admin (client-side)</span>
    </h1>

    <div class="card">
      <h3>Create License</h3>
      <div class="row">
        <div style="flex:1;">
          <label>Channel ID</label>
          <input type="text" id="channelId" placeholder="e.g. Droopy">
        </div>
        <div style="flex:1;">
          <label>License Key</label>
          <input type="text" id="licenseKey" placeholder="Auto-generate or enter manually">
        </div>
        <div style="display:flex;align-items:center;gap:10px;margin-top:25px;">
          <input type="checkbox" id="isActive" checked>
          <label for="isActive" style="margin:0;">Active</label>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn-secondary" id="generateKey">Generate</button>
        <button class="btn-primary" id="createLicense">Create License</button>
        <span id="createMsg" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <h3>Manage Licenses</h3>
      <div class="row">
        <div style="flex:1;">
          <label>Channel to view</label>
          <input type="text" id="viewChannel" placeholder="e.g. Droopy">
        </div>
        <button class="btn-secondary" id="loadLicenses" style="margin-top:24px;">Load</button>
        <button class="btn-secondary" id="refreshList" style="margin-top:24px;">Refresh</button>
      </div>
      <div id="licenseList" style="margin-top:14px;"></div>
    </div>
    <div class="muted" style="text-align:right;">v1.1 — Admin utility (private)</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, get, set, remove, update } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const app = initializeApp({
      apiKey: "AIzaSyASjfLh3w3UQHRy1wvmWwD5ZfaXWjVYTnE",
      authDomain: "marvel-rivals-overlay-7f867.firebaseapp.com",
      databaseURL: "https://marvel-rivals-overlay-7f867-default-rtdb.firebaseio.com",
      projectId: "marvel-rivals-overlay-7f867",
      storageBucket: "marvel-rivals-overlay-7f867.appspot.com",
      messagingSenderId: "1078364810175",
      appId: "1:1078364810175:web:fac410007b70b65e348f0a"
    });
    const db = getDatabase(app);

    const $ = id => document.getElementById(id);
    const fmt = t => new Date(t).toLocaleString();

    $("generateKey").onclick = () => {
      $("licenseKey").value = "RIV-" + Math.random().toString(36).substring(2,10).toUpperCase();
    };

    $("createLicense").onclick = async () => {
      const ch = $("channelId").value.trim();
      const key = $("licenseKey").value.trim();
      const active = $("isActive").checked;
      if(!ch || !key){ $("createMsg").textContent="⚠️ Missing fields."; return; }

      const refPath = ref(db, `channels/${ch}/licenses/${key}`);
      const snap = await get(refPath);
      if(snap.exists()){ $("createMsg").textContent="⚠️ License already exists."; return; }

      const data = {
        active,
        assignedTo: ch,
        since: new Date().toISOString()
      };
      await set(refPath, data);
      $("createMsg").textContent="✓ License created.";
      setTimeout(()=> $("createMsg").textContent="", 2000);
      loadLicenses(ch);
    };

    async function loadLicenses(ch){
      if(!ch) return;
      const refPath = ref(db, `channels/${ch}/licenses`);
      const snap = await get(refPath);
      const div = $("licenseList");
      div.innerHTML="";
      if(!snap.exists()){ div.textContent="No licenses found."; return; }
      const data = snap.val();
      for(const [key,val] of Object.entries(data)){
        const item=document.createElement("div");
        item.className="license-item";
        item.innerHTML=`
          <div>
            <strong>${ch}</strong> 
            <span class="pill ${val.active?'active':'inactive'}">${val.active?'Active':'Inactive'}</span> 
            <span class="muted">Key: ${key}</span> 
            <span class="muted">Assigned: ${val.assignedTo||'—'}</span> 
            <span class="muted">Since: ${val.since?fmt(val.since):'—'}</span>
          </div>
          <div class="row">
            <button class="btn-copy" onclick="navigator.clipboard.writeText('${key}')">Copy</button>
            <button class="btn-warning" onclick="toggleActive('${ch}','${key}',${!val.active})">${val.active?'Deactivate':'Activate'}</button>
            <button class="btn-warning" onclick="deleteLicense('${ch}','${key}')">Delete</button>
          </div>
        `;
        div.appendChild(item);
      }
    }

    window.toggleActive = async (ch,key,newState)=>{
      await update(ref(db, `channels/${ch}/licenses/${key}`), { active:newState });
      loadLicenses(ch);
    };

    window.deleteLicense = async (ch,key)=>{
      if(!confirm("Delete this license?")) return;
      await remove(ref(db, `channels/${ch}/licenses/${key}`));
      loadLicenses(ch);
    };

    $("loadLicenses").onclick = ()=> loadLicenses($("viewChannel").value.trim());
    $("refreshList").onclick = ()=> loadLicenses($("viewChannel").value.trim());
  </script>
</body>
</html>
